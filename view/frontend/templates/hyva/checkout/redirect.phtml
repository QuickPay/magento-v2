<?php
/**
 * QuickPay Gateway - Hyva Checkout Redirect Template
 * Handles redirect functionality for QuickPay payment methods in Hyva checkout
 */

declare(strict_types=1);

use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;

/** @var Template $block */
/** @var Escaper $escaper */
?>

<script>
(() => {
    // Wait for Magewire to be available
    window.addEventListener('magewire:available', () => {
        // Listen for successful order placement
        Magewire.on('order_placed_successfully', (event) => {
            const paymentMethod = event.paymentMethod;
            
            // Check if it's a QuickPay payment method
            if (paymentMethod && paymentMethod.includes('quickpay')) {
                // Get redirect URL from checkout config
                const redirectUrl = window.checkoutConfig?.payment?.[paymentMethod]?.redirectUrl;
                
                if (redirectUrl) {
                    // Use Hyva's redirect mechanism
                    window.dispatchEvent(new CustomEvent('hyva:checkout:redirect', {
                        detail: {
                            url: redirectUrl,
                            method: 'replace'
                        }
                    }));
                }
            }
        });
        
        // Listen for evaluation results that contain redirects
        Magewire.on('evaluation_result_processed', (event) => {
            if (event.result && event.result.type === 'redirect') {
                const redirectUrl = event.result.url;
                
                if (redirectUrl && redirectUrl.includes('quickpaygateway')) {
                    // Redirect using window.location.replace
                    window.location.replace(redirectUrl);
                }
            }
        });
        
        // Alternative approach: Listen for payment method specific events
        Magewire.on('payment_method_processed', (event) => {
            const method = event.method;
            
            if (method && method.includes('quickpay')) {
                const redirectUrl = window.checkoutConfig?.payment?.[method]?.redirectUrl;
                
                if (redirectUrl) {
                    // Redirect using window.location.replace
                    window.location.replace(redirectUrl);
                }
            }
        });
    });
})();
</script>
